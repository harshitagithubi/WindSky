<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindSky Weather Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .app-title {
            font-size: 3rem;
            font-weight: 900;
            color: #000000;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .controls input {
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            color: #000000;
            width: 120px;
        }
        
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .controls button:hover {
            transform: translateY(-2px);
        }
        
        .main-weather {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: stretch;
            margin-bottom: 30px;
        }
        
        .weather-card, .forecast-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .current-temp {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .condition {
            font-size: 1.2rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .location-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .detail-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .forecast-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .hourly-forecast {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .hourly-item {
            min-width: 80px;
            text-align: center;
            padding: 15px 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .hour {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .hourly-temp {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .hourly-precip {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .daily-forecast {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .daily-item {
            display: grid;
            grid-template-columns: 80px 1fr 100px 60px;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .day-name {
            font-weight: 600;
        }
        
        .day-condition {
            opacity: 0.8;
        }
        
        .day-temps {
            font-weight: bold;
        }
        
        .day-precip {
            text-align: center;
            opacity: 0.7;
        }
        
        .sun-moon-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .sun-moon-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .sun-moon-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .sun-moon-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .sun-icon {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        }
        
        .moon-icon {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        
        .sun-moon-details {
            flex: 1;
        }
        
        .sun-moon-label {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .sun-moon-times {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            opacity: 0.8;
        }
        
        canvas {
            max-height: 200px !important;
        }
        
        .aqi-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 20px;
        }
        
        .aqi-bar {
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #006400, #8A8000, #ff8c00, #ff3b3b, #7a1fff, #4b003b);
            border-radius: 10px;
            position: relative;
            margin: 15px 0;
        }
        
        .aqi-thumb {
            position: absolute;
            top: -5px;
            width: 30px;
            height: 30px;
            background: #000;
            border-radius: 50%;
            border: 3px solid white;
            transition: left 0.3s ease;
        }
        
        .health-suggestions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .suggestion-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .suggestion-text {
            flex: 1;
        }
            .main-weather {
                grid-template-columns: 1fr 1fr;
            }
            
            .sun-moon-section {
                grid-template-columns: 1fr;
            }
            
            .daily-item {
                grid-template-columns: 60px 1fr 80px 50px;
                font-size: 0.9rem;
            }
            
            .app-title {
                font-size: 2rem;
            }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">WindSky</h1>
            <div class="controls">
                <input type="number" id="lat" placeholder="Latitude" step="any">
                <input type="number" id="lon" placeholder="Longitude" step="any">
                <button id="fetchBtn">Fetch Weather</button>
                <button id="geolBtn">Use Location</button>
            </div>
        </div>
        
        <div class="main-weather">
            <div class="weather-card">
                <div id="locationName" class="location-name">Loading...</div>
                <div id="tempVal" class="current-temp">--°</div>
                <div id="condText" class="condition">--</div>
                <div id="localTime" style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 15px;">--</div>
                <img id="weatherIcon" style="width: 60px; height: 60px; margin: 10px 0;">
                <button id="showMapBtn" style="
                    margin-top: 10px;
                    padding: 8px 16px;
                    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    📍 View Map
                </button>
            </div>
            
            <div class="weather-card">
                <div class="weather-details">
                    <div class="detail-item">
                        <span class="detail-label">Wind</span>
                        <span id="windText" class="detail-value">-- kph</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Humidity</span>
                        <span id="humVal" class="detail-value">--%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Visibility</span>
                        <span id="visVal" class="detail-value">-- km</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Pressure</span>
                        <span id="presVal" class="detail-value">-- mb</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">UV Index</span>
                        <span id="uvVal" class="detail-value">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Precip Today</span>
                        <span id="precipToday" class="detail-value">-- mm</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Modal -->
        <div id="mapModal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        ">
            <div style="
                position: relative;
                width: 90%;
                height: 80%;
                margin: 5% auto;
                background: rgba(255,255,255,0.95);
                border-radius: 20px;
                overflow: hidden;
            ">
                <button id="closeMapBtn" style="
                    position: absolute;
                    top: 15px;
                    right: 20px;
                    z-index: 1001;
                    background: rgba(255,255,255,0.9);
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    cursor: pointer;
                    font-size: 18px;
                    backdrop-filter: blur(10px);
                ">✕</button>
                <iframe id="mapFrame" 
                    width="100%" 
                    height="100%" 
                    frameborder="0" 
                    style="border: none; border-radius: 20px;"
                    loading="lazy">
                </iframe>
            </div>
        </div>
        
        <div class="forecast-section">
            <div class="section-title">Hourly Weather</div>
            <div id="hourlyList" class="hourly-forecast">
                <!-- Hourly items will be populated here -->
            </div>
        </div>
        
        <div class="forecast-section">
            <div class="section-title">10-Day Weather Forecast</div>
            <div id="dailyForecast" class="daily-forecast">
                <!-- Daily items will be populated here -->
            </div>
        </div>
        
        <div class="sun-moon-section">
            <div class="sun-moon-card">
                <div class="section-title">Sun & Moon</div>
                <div class="sun-moon-item">
                    <div class="sun-moon-icon sun-icon">☀</div>
                    <div class="sun-moon-details">
                        <div class="sun-moon-label" id="sunDuration">12 hrs 12 mins</div>
                        <div class="sun-moon-times">
                            <span>Rise <span id="sunRise">06:09</span></span>
                            <span>Set <span id="sunSet">18:21</span></span>
                        </div>
                    </div>
                </div>
                <div class="sun-moon-item">
                    <div class="sun-moon-icon moon-icon">🌙</div>
                    <div class="sun-moon-details">
                        <div class="sun-moon-label" id="moonPhase">Waning Crescent</div>
                        <div class="sun-moon-times">
                            <span>Rise <span id="moonRise">04:34</span></span>
                            <span>Set <span id="moonSet">17:35</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="aqi-section">
                <div class="section-title">Air Quality</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 2rem; font-weight: bold;" id="aqiVal">--</span>
                    <span id="aqiCat" style="font-weight: 600;">--</span>
                </div>
                <div class="aqi-bar">
                    <div id="aqiThumb" class="aqi-thumb"></div>
                </div>
                <div style="font-size: 0.9rem; opacity: 0.8;">
                    PM2.5: <span id="pm25Text">-- µg/m³</span>
                </div>
            </div>
        </div>
        
        <!-- Health & Weather Suggestions -->
        <div class="forecast-section">
            <div class="section-title">Health & Weather Suggestions</div>
            <div id="healthSuggestions" class="health-suggestions">
                <div class="suggestion-item">📋 Loading health recommendations...</div>
            </div>
        </div>
        
        <div id="chartsContainer" class="charts-container" style="display: none;">
            <div class="chart-card">
                <div class="chart-title">Temperature Forecast</div>
                <canvas id="chartTemp"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">Precipitation</div>
                <canvas id="chartPrecip"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">Wind Speed</div>
                <canvas id="chartWind"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">Hourly Temperature</div>
                <canvas id="chartHourly"></canvas>
            </div>
        </div>
        
        <div id="rainExp" style="text-align: center; margin: 20px 0; font-style: italic; opacity: 0.8;"></div>
    </div>

    <script>
/*
  WindSky — Open-Meteo frontend-only dashboard
  - Uses open-meteo.com endpoints (no key)
  - PM2.5 -> AQI (US EPA) interpolation function included
  - Chart.js for charts
  - Added reverse geocoding for proper location names
*/

/* ----------------- Helpers & AQI conversion ----------------- */

// PM2.5 -> AQI based on US EPA breakpoints (simple linear interpolation)
function pm25ToAQI(pm25) {
  const breaks = [
    [0.0, 12.0, 0, 50],
    [12.1, 35.4, 51, 100],
    [35.5, 55.4, 101, 150],
    [55.5, 150.4, 151, 200],
    [150.5, 250.4, 201, 300],
    [250.5, 350.4, 301, 400],
    [350.5, 500.4, 401, 500]
  ];
  if (pm25 === null || pm25 === undefined || isNaN(pm25)) return null;
  const C = Math.round(pm25 * 10) / 10;
  for (let i = 0; i < breaks.length; i++) {
    const [pmLo, pmHi, aLo, aHi] = breaks[i];
    if (C >= pmLo && C <= pmHi) return Math.round(((aHi - aLo) / (pmHi - pmLo)) * (C - pmLo) + aLo);
  }
  return Math.min(500, Math.round((C / 500.4) * 500));
}

function aqiCategory(aqi) {
  if (aqi === null) return 'Unknown';
  if (aqi <= 50) return 'Good';
  if (aqi <= 100) return 'Moderate';
  if (aqi <= 150) return 'Unhealthy (SG)';
  if (aqi <= 200) return 'Unhealthy';
  if (aqi <= 300) return 'Very Unhealthy';
  return 'Hazardous';
}

/* ----------------- Reverse Geocoding ----------------- */

async function reverseGeocode(lat, lon) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&format=json&zoom=14&addressdetails=1`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Reverse geocode failed');
    const data = await res.json();
    const addr = data.address || {};
    
    // Try to get more specific location first
    const specificLocation = addr.neighbourhood || addr.suburb || addr.village || addr.town || addr.city;
    const broader = addr.city || addr.state_district || addr.state;
    
    if (specificLocation && broader && specificLocation !== broader) {
      return `${specificLocation}, ${broader}`;
    }
    
    return specificLocation || broader || data.display_name || `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  } catch (err) {
    console.error('Reverse geocode error', err);
    return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
  }
}

/* ----------------- DOM elements & charts ----------------- */

const el = {
  lat: document.getElementById('lat'),
  lon: document.getElementById('lon'),
  fetchBtn: document.getElementById('fetchBtn'),
  geolBtn: document.getElementById('geolBtn'),
  tempVal: document.getElementById('tempVal'),
  condText: document.getElementById('condText'),
  weatherIcon: document.getElementById('weatherIcon'),
  locationName: document.getElementById('locationName'),
  aqiVal: document.getElementById('aqiVal'),
  aqiCat: document.getElementById('aqiCat'),
  aqiThumb: document.getElementById('aqiThumb'),
  pm25Text: document.getElementById('pm25Text'),
  windText: document.getElementById('windText'),
  rainExp: document.getElementById('rainExp'),
  precipToday: document.getElementById('precipToday'),
  humVal: document.getElementById('humVal'),
  visVal: document.getElementById('visVal'),
  presVal: document.getElementById('presVal'),
  uvVal: document.getElementById('uvVal'),
  hourlyList: document.getElementById('hourlyList'),
  dailyForecast: document.getElementById('dailyForecast'),
  sunRise: document.getElementById('sunRise'),
  sunSet: document.getElementById('sunSet'),
  sunDuration: document.getElementById('sunDuration'),
  moonRise: document.getElementById('moonRise'),
  moonSet: document.getElementById('moonSet'),
  moonPhase: document.getElementById('moonPhase'),
  localTime: document.getElementById('localTime'),
  chartsContainer: document.getElementById('chartsContainer'),
  showMapBtn: document.getElementById('showMapBtn'),
  mapModal: document.getElementById('mapModal'),
  closeMapBtn: document.getElementById('closeMapBtn'),
  mapFrame: document.getElementById('mapFrame'),
  healthSuggestions: document.getElementById('healthSuggestions')
};

let charts = {};

/* ----------------- Chart helpers ----------------- */
function createOrUpdateChart(id, canvasId, type, labels, datasets, options={}) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (charts[id]) {
    charts[id].data.labels = labels;
    charts[id].data.datasets = datasets;
    charts[id].update();
    return;
  }
  charts[id] = new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: Object.assign({
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'top' } },
      scales: { x: { display: true } }
    }, options)
  });
}

/* ----------------- Open-Meteo fetch ----------------- */

function buildForecastUrl(lat, lon, days=10) {
  const hourly = ['temperature_2m','relativehumidity_2m','apparent_temperature','precipitation','windspeed_10m','weathercode','visibility','pressure_msl','uv_index','uv_index_clear_sky'].join(',');
  const daily = ['temperature_2m_max','temperature_2m_min','precipitation_sum','sunrise','sunset','weathercode','uv_index_max'].join(',');
  return `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&hourly=${hourly}&daily=${daily}&current_weather=true&forecast_days=${days}&timezone=auto`;
}

function buildAQUrl(lat, lon) {
  return `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&hourly=pm10,pm2_5,carbon_monoxide,nitrogen_dioxide,ozone`;
}

/* ----------------- Rendering helpers ----------------- */

function generateHealthSuggestions(tempC, aqi, weatherCode, uvIndex, windSpeed, humidity) {
  const suggestions = [];
  
  // Temperature-based suggestions
  if (tempC > 35) {
    suggestions.push({ icon: '🌡️', text: 'Extreme heat warning! Stay hydrated, avoid outdoor activities during peak hours, and wear light-colored clothing.' });
    suggestions.push({ icon: '💧', text: 'Drink water every 15-20 minutes even if you don\'t feel thirsty. Avoid alcohol and caffeine.' });
  } else if (tempC > 30) {
    suggestions.push({ icon: '☀️', text: 'Hot weather ahead! Wear lightweight, breathable fabrics and seek shade when possible.' });
  } else if (tempC < 10) {
    suggestions.push({ icon: '🧥', text: 'Cold weather! Layer your clothing and protect exposed skin to prevent frostbite.' });
  } else if (tempC < 20) {
    suggestions.push({ icon: '🧤', text: 'Cool temperatures - wear a light jacket and consider gloves if going out early morning.' });
  }
  
  // AQI-based suggestions
  if (aqi > 200) {
    suggestions.push({ icon: '😷', text: 'Very unhealthy air! Wear N95 masks outdoors, avoid outdoor exercise, and consider air purifiers indoors.' });
    suggestions.push({ icon: '🏠', text: 'Stay indoors as much as possible. Close windows and use air purifiers if available.' });
  } else if (aqi > 150) {
    suggestions.push({ icon: '😷', text: 'Unhealthy air quality! Wear masks outdoors and limit outdoor activities, especially for sensitive groups.' });
  } else if (aqi > 100) {
    suggestions.push({ icon: '🌬️', text: 'Moderate air quality - sensitive individuals should consider wearing masks and reducing outdoor activities.' });
  } else if (aqi > 50) {
    suggestions.push({ icon: '✅', text: 'Air quality is acceptable for most people, but sensitive individuals may experience minor issues.' });
  }
  
  // UV Index suggestions
  if (uvIndex > 8) {
    suggestions.push({ icon: '🧴', text: 'Very high UV! Apply SPF 30+ sunscreen every 2 hours, wear wide-brimmed hats and UV-blocking sunglasses.' });
  } else if (uvIndex > 5) {
    suggestions.push({ icon: '🕶️', text: 'High UV exposure - wear sunscreen, sunglasses, and seek shade during midday hours.' });
  } else if (uvIndex > 2) {
    suggestions.push({ icon: '☀️', text: 'Moderate UV levels - consider sunscreen for extended outdoor activities.' });
  }
  
  // Weather-specific suggestions
  if (weatherCode >= 61 && weatherCode <= 67) { // Rain
    suggestions.push({ icon: '☔', text: 'Rain expected! Carry an umbrella, wear waterproof shoes, and drive carefully on wet roads.' });
  } else if (weatherCode >= 71 && weatherCode <= 86) { // Snow
    suggestions.push({ icon: '❄️', text: 'Snow conditions! Wear non-slip shoes, dress in layers, and allow extra travel time.' });
  } else if (weatherCode >= 95) { // Thunderstorm
    suggestions.push({ icon: '⛈️', text: 'Thunderstorm warning! Avoid outdoor activities, unplug electronics, and stay away from windows.' });
  } else if (weatherCode >= 45 && weatherCode <= 48) { // Fog
    suggestions.push({ icon: '🌫️', text: 'Foggy conditions! Drive with headlights on, reduce speed, and use fog lights if available.' });
  }
  
  // Wind-based suggestions
  if (windSpeed > 30) {
    suggestions.push({ icon: '💨', text: 'Strong winds! Secure loose objects, be cautious while driving, and avoid outdoor activities.' });
  }
  
  // Humidity suggestions
  if (humidity > 80) {
    suggestions.push({ icon: '💦', text: 'High humidity! Stay in air-conditioned spaces when possible and wear moisture-wicking clothing.' });
  } else if (humidity < 30) {
    suggestions.push({ icon: '🧴', text: 'Low humidity - use moisturizers, drink plenty of water, and consider a humidifier indoors.' });
  }
  
  // Default suggestion if no specific conditions
  if (suggestions.length === 0) {
    suggestions.push({ icon: '🌤️', text: 'Pleasant weather conditions! Great day for outdoor activities and fresh air.' });
  }
  
  // Limit to 5 suggestions max
  return suggestions.slice(0, 5);
}

function updateHealthSuggestions(tempC, aqi, weatherCode, uvIndex, windSpeed, humidity) {
  const suggestions = generateHealthSuggestions(tempC, aqi, weatherCode, uvIndex, windSpeed, humidity);
  
  el.healthSuggestions.innerHTML = '';
  suggestions.forEach(suggestion => {
    const item = document.createElement('div');
    item.className = 'suggestion-item';
    item.innerHTML = `
      <span class="suggestion-icon">${suggestion.icon}</span>
      <span class="suggestion-text">${suggestion.text}</span>
    `;
    el.healthSuggestions.appendChild(item);
  });
}

function setBackgroundByTemp(tempC) {
    document.body.style.background = 'linear-gradient(180deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd)';
    document.body.style.color = '#ffffff';
}

function updateAQIBar(aqi) {
  if (aqi === null) { el.aqiThumb.style.left='0%'; return; }
  const percent = Math.max(0, Math.min(100,(aqi/500)*100));
  el.aqiThumb.style.left = percent+'%';
  let thumbColor = '#000';
  if (aqi<=50) thumbColor='#006400';
  else if(aqi<=100) thumbColor='#8A8000';
  else if(aqi<=150) thumbColor='#ff8c00';
  else if(aqi<=200) thumbColor='#ff3b3b';
  else if(aqi<=300) thumbColor='#7a1fff';
  else thumbColor='#4b003b';
  el.aqiThumb.style.background = thumbColor;
}

function formatTime(timeStr) {
  if (!timeStr) return '--:--';
  const time = new Date(timeStr);
  return time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
}

function calculateSunDuration(sunrise, sunset) {
  if (!sunrise || !sunset) return '--';
  const start = new Date(sunrise);
  const end = new Date(sunset);
  const diffMs = end - start;
  const hours = Math.floor(diffMs / (1000 * 60 * 60));
  const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
  return `${hours} hrs ${minutes} mins`;
}

function getDayName(dateStr) {
  const today = new Date();
  const date = new Date(dateStr);
  const dayDiff = Math.floor((date - today) / (1000 * 60 * 60 * 24));
  
  if (dayDiff === 0) return 'TODAY';
  if (dayDiff === 1) return 'SUN';
  if (dayDiff === 2) return 'MON';
  if (dayDiff === 3) return 'TUE';
  if (dayDiff === 4) return 'WED';
  if (dayDiff === 5) return 'THU';
  if (dayDiff === 6) return 'FRI';
  
  return date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
}

/* ----------------- Main fetch & render ----------------- */

async function fetchAndRender(lat, lon) {
  try {
    el.fetchBtn.disabled=true; el.fetchBtn.textContent='Loading...';

    const forecastUrl = buildForecastUrl(lat, lon, 10);
    const aqUrl = buildAQUrl(lat, lon);

    const [fRes, aRes] = await Promise.all([fetch(forecastUrl), fetch(aqUrl)]);
    if(!fRes.ok) throw new Error('Forecast fetch failed');
    if(!aRes.ok) throw new Error('AQ fetch failed');

    const fjson = await fRes.json();
    const ajson = await aRes.json();

    // Reverse geocode for proper location name
    const locName = await reverseGeocode(lat, lon);
    el.locationName.textContent = locName;

    const cur = fjson.current_weather || {};
    const tz = fjson.timezone || '';
    el.tempVal.textContent = cur.temperature!==undefined? Math.round(cur.temperature)+'°C' : '--';
    el.condText.textContent = cur.weathercode!==undefined? weatherCodeToText(cur.weathercode) : '—';
    el.windText.textContent = cur.windspeed!==undefined? cur.windspeed+' km/h' : '--';
    el.localTime.textContent = 'Local time: ' + (fjson.hourly?.time?.[0]||'--').split('T')[1]?.slice(0,5) || '--';
    setBackgroundByTemp(Number(cur.temperature)||0);
    el.weatherIcon.src = weatherCodeToIcon(cur.weathercode);

    const hourly = fjson.hourly || {};
    const daily = fjson.daily || {};

    // Update additional weather details
    if (hourly.relativehumidity_2m?.[0] !== undefined) {
      el.humVal.textContent = hourly.relativehumidity_2m[0] + '%';
    }
    if (hourly.visibility?.[0] !== undefined) {
      el.visVal.textContent = (hourly.visibility[0]/1000).toFixed(1) + ' km';
    }
    if (hourly.pressure_msl?.[0] !== undefined) {
      el.presVal.textContent = Math.round(hourly.pressure_msl[0]) + ' mb';
    }
    
    // UV Index - try multiple sources
    let uvIndex = null;
    if (hourly.uv_index?.[0] !== undefined && hourly.uv_index[0] > 0) {
      uvIndex = hourly.uv_index[0];
    } else if (daily.uv_index_max?.[0] !== undefined && daily.uv_index_max[0] > 0) {
      uvIndex = daily.uv_index_max[0];
    } else if (hourly.uv_index_clear_sky?.[0] !== undefined) {
      uvIndex = hourly.uv_index_clear_sky[0];
    }
    
    if (uvIndex !== null) {
      el.uvVal.textContent = Math.round(uvIndex * 10) / 10;
    } else {
      // Check current time - UV is 0 at night
      const currentHour = new Date().getHours();
      if (currentHour < 6 || currentHour > 18) {
        el.uvVal.textContent = '0 (Night)';
      } else {
        el.uvVal.textContent = 'N/A';
      }
    }

    // Hourly list (today)
    const nowISO = hourly.time && hourly.time.length ? hourly.time[0].split('T')[0] : null;
    el.hourlyList.innerHTML = '';
    if(hourly.time) {
      for(let i=0;i<Math.min(24, hourly.time.length);i++){
        if(nowISO && !hourly.time[i].startsWith(nowISO)) continue;
        const hr = document.createElement('div');
        hr.className = 'hourly-item';
        const t = hourly.time[i].split('T')[1]?.slice(0,5)||'--';
        const temp = (hourly.temperature_2m && hourly.temperature_2m[i]!==undefined)?Math.round(hourly.temperature_2m[i]):'--';
        const precip = (hourly.precipitation && hourly.precipitation[i]!==undefined)?hourly.precipitation[i]:0;
        const weatherCode = hourly.weathercode?.[i];
        
        hr.innerHTML=`
          <div class="hour">${t}</div>
          <div style="font-size: 24px; margin: 5px 0;">${getWeatherEmoji(weatherCode)}</div>
          <div class="hourly-temp">${temp}°</div>
          <div class="hourly-precip">${precip}%</div>
        `;
        el.hourlyList.appendChild(hr);
      }
    }

    // Daily forecast
    el.dailyForecast.innerHTML = '';
    if(daily.time) {
      for(let i=0; i<daily.time.length; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'daily-item';
        const dayName = getDayName(daily.time[i]);
        const maxTemp = daily.temperature_2m_max?.[i] ? Math.round(daily.temperature_2m_max[i]) : '--';
        const minTemp = daily.temperature_2m_min?.[i] ? Math.round(daily.temperature_2m_min[i]) : '--';
        const precip = daily.precipitation_sum?.[i] || 0;
        const weatherCode = daily.weathercode?.[i];
        const condition = weatherCodeToText(weatherCode);
        
        dayEl.innerHTML = `
          <div class="day-name">${dayName}</div>
          <div>
            <div style="font-size: 20px; margin-bottom: 5px;">${getWeatherEmoji(weatherCode)}</div>
            <div class="day-condition">${condition}</div>
          </div>
          <div class="day-temps">${maxTemp}° ${minTemp}°</div>
          <div class="day-precip">${precip > 0 ? Math.round(precip) + '%' : '0%'}</div>
        `;
        el.dailyForecast.appendChild(dayEl);
      }
    }

    // Sun and Moon data
    if (daily.sunrise?.[0] && daily.sunset?.[0]) {
      el.sunRise.textContent = formatTime(daily.sunrise[0]);
      el.sunSet.textContent = formatTime(daily.sunset[0]);
      el.sunDuration.textContent = calculateSunDuration(daily.sunrise[0], daily.sunset[0]);
    }

    // Mock moon data (Open-Meteo doesn't provide moon data)
    el.moonPhase.textContent = 'Waning Crescent';
    el.moonRise.textContent = '04:34';
    el.moonSet.textContent = '17:35';

    // Rain expectation
    const upcomingRain=[];
    for(let i=0;i<daily.time.length;i++){
      const precip = daily.precipitation_sum?.[i] || 0;
      if(precip > 0.5) upcomingRain.push(`${daily.time[i]}: ${precip} mm`);
    }
    el.rainExp.textContent = upcomingRain.length? upcomingRain.join(' | ') : 'Low chance of rain in next 10 days.';
    el.precipToday.textContent = (daily.precipitation_sum?.[0] || 0) + ' mm';

    // AQI
    const pm25Now = ajson.hourly?.pm2_5?.[0]||0;
    const aqiNow = pm25ToAQI(pm25Now);
    el.aqiVal.textContent = aqiNow || '--';
    el.aqiCat.textContent = aqiCategory(aqiNow);
    el.pm25Text.textContent = pm25Now+' µg/m³';
    updateAQIBar(aqiNow);

    // Generate health suggestions
    const currentTemp = Number(cur.temperature) || 0;
    const currentUV = uvIndex || 0;
    const currentWind = Number(cur.windspeed) || 0;
    const currentHumidity = hourly.relativehumidity_2m?.[0] || 0;
    const currentWeatherCode = cur.weathercode || 0;
    
    updateHealthSuggestions(currentTemp, aqiNow, currentWeatherCode, currentUV, currentWind, currentHumidity);

    // Show charts only if we have real data
    if (daily.time && daily.time.length > 1) {
      el.chartsContainer.style.display = 'grid';
      
      // Daily charts
      const labels = daily.time||[];
      const tmax = daily.temperature_2m_max||[];
      const tmin = daily.temperature_2m_min||[];
      const precip = daily.precipitation_sum||[];

      createOrUpdateChart('tempChart', 'chartTemp', 'line', labels, [
        {label:'Max °C', data:tmax, tension:0.3, borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)'},
        {label:'Min °C', data:tmin, tension:0.3, borderColor: '#4ecdc4', backgroundColor: 'rgba(78,205,196,0.1)'}
      ]);
      
      createOrUpdateChart('chartPrecip', 'chartPrecip', 'bar', labels, [
        {label:'Precip (mm)', data:precip, backgroundColor: 'rgba(74,144,226,0.6)', borderColor: '#4a90e2'}
      ]);

      const hourlyTimes = hourly.time||[];
      const hourlyWinds = hourly.windspeed_10m||[];
      const dailyMaxWind = labels.map(d=>{
        let maxW=0;
        for(let i=0;i<hourlyTimes.length;i++){
          if(hourlyTimes[i].startsWith(d)){
            const w = Number(hourlyWinds[i]||0);
            if(w>maxW) maxW=w;
          }
        }
        return Math.round(maxW*10)/10;
      });
      
      createOrUpdateChart('chartWind', 'chartWind', 'line', labels, [
        {label:'Max wind km/h', data:dailyMaxWind, tension:0.3, borderColor: '#95e1d3', backgroundColor: 'rgba(149,225,211,0.1)'}
      ]);

      // Hourly chart for today
      const hourLabels=[]; const hourTemps=[];
      for(let i=0;i<Math.min(24, hourly.time.length);i++){
        if(nowISO && hourly.time[i].startsWith(nowISO)){
          hourLabels.push(hourly.time[i].split('T')[1]?.slice(0,5)||'--');
          hourTemps.push(hourly.temperature_2m[i]);
        }
      }
      
      createOrUpdateChart('chartHourly', 'chartHourly', 'line', hourLabels, [
        {label:'°C', data:hourTemps, tension:0.3, borderColor: '#feca57', backgroundColor: 'rgba(254,202,87,0.1)'}
      ]);
    } else {
      el.chartsContainer.style.display = 'none';
    }

  } catch(err) {
    console.error(err);
    alert('Error fetching data. See console.');
  } finally {
    el.fetchBtn.disabled=false; el.fetchBtn.textContent='Fetch Weather';
  }
}

/* ----------------- Weather codes ----------------- */

function weatherCodeToText(code) {
  const map = {
    0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',
    45:'Fog',48:'Depositing rime fog',51:'Drizzle: light',53:'Drizzle: moderate',
    55:'Drizzle: dense',56:'Freezing drizzle',57:'Dense freezing drizzle',
    61:'Rain: slight',63:'Rain: moderate',65:'Rain: heavy',
    66:'Freezing rain',67:'Heavy freezing rain',71:'Snow: slight',
    73:'Snow: moderate',75:'Snow: heavy',77:'Snow grains',
    80:'Rain showers: slight',81:'Rain showers: moderate',82:'Rain showers: violent',
    85:'Snow showers slight',86:'Snow showers heavy',95:'Thunderstorm',
    96:'Thunderstorm with slight hail',99:'Thunderstorm with heavy hail'
  };
  return map[code]||'Unknown';
}

function weatherCodeToIcon(code) {
  // Placeholder icons - you can replace with actual icon URLs
  if(code===0) return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="orange"><circle cx="12" cy="12" r="5"/><path d="m12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>';
  if(code>=1 && code<=3) return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gray"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>';
  return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="lightblue"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>';
}

function getWeatherEmoji(code) {
  if(code===0) return '☀️';
  if(code>=1 && code<=3) return '⛅';
  if(code>=45 && code<=48) return '🌫️';
  if(code>=51 && code<=67) return '🌧️';
  if(code>=71 && code<=86) return '🌨️';
  if(code>=95) return '⛈️';
  return '☁️';
}

/* ----------------- Event listeners ----------------- */

let currentLat = 28.6139;
let currentLon = 77.2090;

el.fetchBtn.addEventListener('click', ()=>{
  const lat = Number(el.lat.value);
  const lon = Number(el.lon.value);
  if(isNaN(lat)||isNaN(lon)) return alert('Enter valid lat & lon');
  currentLat = lat;
  currentLon = lon;
  fetchAndRender(lat, lon);
});

el.geolBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(pos=>{
    el.lat.value = pos.coords.latitude.toFixed(4);
    el.lon.value = pos.coords.longitude.toFixed(4);
    currentLat = pos.coords.latitude;
    currentLon = pos.coords.longitude;
    fetchAndRender(pos.coords.latitude, pos.coords.longitude);
  }, err=>{alert('Geolocation failed')});
});

// Map functionality
el.showMapBtn.addEventListener('click', () => {
  const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${currentLon-0.01},${currentLat-0.01},${currentLon+0.01},${currentLat+0.01}&layer=mapnik&marker=${currentLat},${currentLon}`;
  el.mapFrame.src = mapUrl;
  el.mapModal.style.display = 'block';
});

el.closeMapBtn.addEventListener('click', () => {
  el.mapModal.style.display = 'none';
});

el.mapModal.addEventListener('click', (e) => {
  if (e.target === el.mapModal) {
    el.mapModal.style.display = 'none';
  }
});

/* ----------------- Init default ----------------- */
currentLat = 28.6139;
currentLon = 77.2090;
fetchAndRender(28.6139, 77.2090); // New Delhi default

    </script>
</body>
</html>
